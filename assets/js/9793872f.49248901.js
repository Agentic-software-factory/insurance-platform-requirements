"use strict";(globalThis.webpackChunkinsurance_platform_requirements=globalThis.webpackChunkinsurance_platform_requirements||[]).push([[188],{93205(e,s,n){n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"lessons-learned/LESSON-001-stale-git-index-build-failure","title":"LESSON-001: Stale Git Index Causes Local Build Failures","description":"Date: 2026-02-10","source":"@site/docs/lessons-learned/LESSON-001-stale-git-index-build-failure.md","sourceDirName":"lessons-learned","slug":"/lessons-learned/LESSON-001-stale-git-index-build-failure","permalink":"/insurance-platform-requirements/docs/next/lessons-learned/LESSON-001-stale-git-index-build-failure","draft":false,"unlisted":false,"editUrl":"https://github.com/Agentic-software-factory/insurance-platform-requirements/edit/main/docs/lessons-learned/LESSON-001-stale-git-index-build-failure.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"requirementsSidebar","previous":{"title":"LESSON-XXX: [Title]","permalink":"/insurance-platform-requirements/docs/next/lessons-learned/LESSON-TEMPLATE"},"next":{"title":"LESSON-002: Intake Must Never Run /next or Start Workers","permalink":"/insurance-platform-requirements/docs/next/lessons-learned/LESSON-002-intake-never-runs-next"}}');var t=n(74848),l=n(28453);const r={sidebar_position:2},d="LESSON-001: Stale Git Index Causes Local Build Failures",c={},o=[{value:"Summary",id:"summary",level:2},{value:"Background",id:"background",level:2},{value:"Context",id:"context",level:3},{value:"Assumptions",id:"assumptions",level:3},{value:"What Happened",id:"what-happened",level:2},{value:"Event description",id:"event-description",level:3},{value:"Timeline",id:"timeline",level:3},{value:"Evidence",id:"evidence",level:3},{value:"Root Cause",id:"root-cause",level:2},{value:"Five Whys",id:"five-whys",level:3},{value:"True root cause",id:"true-root-cause",level:3},{value:"Lesson",id:"lesson",level:2},{value:"What we learned",id:"what-we-learned",level:3},{value:"Key insight",id:"key-insight",level:3},{value:"Actions",id:"actions",level:2},{value:"Immediate fixes",id:"immediate-fixes",level:3},{value:"Long-term changes",id:"long-term-changes",level:3},{value:"Documentation updates",id:"documentation-updates",level:3},{value:"Prevention",id:"prevention",level:2},{value:"How to avoid in future",id:"how-to-avoid-in-future",level:3},{value:"Before starting a work session",id:"before-starting-a-work-session",level:3},{value:"When local build fails but CI passes",id:"when-local-build-fails-but-ci-passes",level:3},{value:"In multi-worker environments",id:"in-multi-worker-environments",level:3},{value:"Related Lessons",id:"related-lessons",level:2},{value:"References",id:"references",level:2}];function a(e){const s={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",input:"input",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"lesson-001-stale-git-index-causes-local-build-failures",children:"LESSON-001: Stale Git Index Causes Local Build Failures"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Date:"})," 2026-02-10"]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Type:"})," Pattern"]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Impact:"})," Time"]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Severity:"})," Medium"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsxs)(s.p,{children:["A stale git index from a previous ",(0,t.jsx)(s.code,{children:"git stash pop"})," caused local ",(0,t.jsx)(s.code,{children:"npm run build"})," to fail with broken link errors, while CI passed on every recent merge to main."]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"background",children:"Background"}),"\n",(0,t.jsx)(s.h3,{id:"context",children:"Context"}),"\n",(0,t.jsxs)(s.p,{children:["Multiple workers running in parallel, merging PRs to main via auto-next. An intake session was running concurrently, reading from the repo. Previous sessions had used ",(0,t.jsx)(s.code,{children:"git stash"})," and ",(0,t.jsx)(s.code,{children:"git pull"})," to handle dirty working trees."]}),"\n",(0,t.jsx)(s.h3,{id:"assumptions",children:"Assumptions"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"git checkout -- ."})," would restore the working tree to match HEAD"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"git clean -fd"})," would remove any leftover files causing issues"]}),"\n",(0,t.jsx)(s.li,{children:"If CI passes, the codebase is correct and local issues are environmental"}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"what-happened",children:"What Happened"}),"\n",(0,t.jsx)(s.h3,{id:"event-description",children:"Event description"}),"\n",(0,t.jsxs)(s.p,{children:["Local ",(0,t.jsx)(s.code,{children:"npm run build"})," failed with broken markdown link errors:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"docs/Architecture/poc-plan-motor-quote.md"})," referenced ",(0,t.jsx)(s.code,{children:"../phase-1-motor/use-cases/quote-and-bind.md"})," (deleted)"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"versioned_docs/version-phase-1/Architecture/poc-plan-motor-quote.md"})," referenced ",(0,t.jsx)(s.code,{children:"../actors/external/transportstyrelsen.md"})," (moved by actors-split PR)"]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Meanwhile, CI showed all green \u2014 ",(0,t.jsx)(s.code,{children:"npm run build"})," passed on every recent merge to main."]}),"\n",(0,t.jsx)(s.h3,{id:"timeline",children:"Timeline"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Noticed local build failure with broken link errors"}),"\n",(0,t.jsxs)(s.li,{children:["Attempted ",(0,t.jsx)(s.code,{children:"git checkout -- ."})," \u2014 did not fix the issue"]}),"\n",(0,t.jsxs)(s.li,{children:["Attempted ",(0,t.jsx)(s.code,{children:"git clean -fd"})," \u2014 did not fix the issue"]}),"\n",(0,t.jsxs)(s.li,{children:["Ran ",(0,t.jsx)(s.code,{children:"git status"})," \u2014 revealed ~150 staged modifications and deletions, residual from a previous ",(0,t.jsx)(s.code,{children:"git stash pop"})," or merge conflict"]}),"\n",(0,t.jsxs)(s.li,{children:["Ran ",(0,t.jsx)(s.code,{children:"git reset --hard HEAD"})," \u2014 resolved the mismatch"]}),"\n",(0,t.jsx)(s.li,{children:"Build succeeded after reset"}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"evidence",children:"Evidence"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"git status"})," output showed ~150 staged changes not present on HEAD"]}),"\n",(0,t.jsx)(s.li,{children:"CI green on all recent PRs to main"}),"\n",(0,t.jsx)(s.li,{children:"Local build failed with broken link errors referencing files deleted or moved in merged PRs"}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"root-cause",children:"Root Cause"}),"\n",(0,t.jsx)(s.h3,{id:"five-whys",children:"Five Whys"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Why did the local build fail with broken links?"}),"\nWorking tree had files that don't exist on HEAD (deleted actors, deleted Phase 2 files)."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Why did the working tree have files not on HEAD?"}),"\nGit index had staged changes from a previous session's ",(0,t.jsx)(s.code,{children:"git stash pop"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsxs)(s.strong,{children:["Why didn't ",(0,t.jsx)(s.code,{children:"git checkout -- ."})," fix it?"]}),"\n",(0,t.jsx)(s.code,{children:"git checkout -- ."})," only resets the working tree, not the index."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsxs)(s.strong,{children:["Why didn't ",(0,t.jsx)(s.code,{children:"git clean -fd"})," fix it?"]}),"\n",(0,t.jsx)(s.code,{children:"git clean -fd"})," only removes untracked files, not staged deletions in the index."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Why was the index stale?"}),"\nA previous session used ",(0,t.jsx)(s.code,{children:"git stash pop"})," which left partially merged changes staged in the index, and no subsequent ",(0,t.jsx)(s.code,{children:"git reset"})," was performed."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"true-root-cause",children:"True root cause"}),"\n",(0,t.jsxs)(s.p,{children:["The git index (staging area) retained changes from a previous ",(0,t.jsx)(s.code,{children:"git stash pop"})," session. Common git cleanup commands (",(0,t.jsx)(s.code,{children:"checkout -- ."}),", ",(0,t.jsx)(s.code,{children:"clean -fd"}),") only affect the working tree and untracked files respectively \u2014 neither touches the index."]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"lesson",children:"Lesson"}),"\n",(0,t.jsx)(s.h3,{id:"what-we-learned",children:"What we learned"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"git checkout -- ."})," resets the working tree but does NOT reset the index"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"git clean -fd"})," removes untracked files but does NOT affect staged changes"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"git status"})," is the essential first diagnostic when local builds diverge from CI"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"git reset --hard HEAD"})," is the only single command that aligns both index and working tree with the current commit"]}),"\n",(0,t.jsxs)(s.li,{children:["In multi-worker environments, ",(0,t.jsx)(s.code,{children:"git stash"})," is risky because stash-pop can leave partial state"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"key-insight",children:"Key insight"}),"\n",(0,t.jsxs)(s.p,{children:["When local build fails but CI passes, the ",(0,t.jsx)(s.strong,{children:"first diagnostic step"})," is ",(0,t.jsx)(s.code,{children:"git status"}),". If it shows unexpected staged changes, the local state is corrupted relative to HEAD. Only ",(0,t.jsx)(s.code,{children:"git reset --hard HEAD"})," aligns both index and working tree with the current commit."]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"actions",children:"Actions"}),"\n",(0,t.jsx)(s.h3,{id:"immediate-fixes",children:"Immediate fixes"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",checked:!0,disabled:!0})," ","Ran ",(0,t.jsx)(s.code,{children:"git reset --hard HEAD"})," to fix the stale index"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",checked:!0,disabled:!0})," ","Verified local build passes after reset"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"long-term-changes",children:"Long-term changes"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",checked:!0,disabled:!0})," ","Added troubleshooting pattern to MEMORY.md"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",checked:!0,disabled:!0})," ","Documented this lesson in ",(0,t.jsx)(s.code,{children:"docs/lessons-learned/"})]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"documentation-updates",children:"Documentation updates"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",checked:!0,disabled:!0})," ","Created this lesson file"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",checked:!0,disabled:!0})," ","Updated lessons-learned index"]}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"prevention",children:"Prevention"}),"\n",(0,t.jsx)(s.h3,{id:"how-to-avoid-in-future",children:"How to avoid in future"}),"\n",(0,t.jsx)(s.h3,{id:"before-starting-a-work-session",children:"Before starting a work session"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["Run ",(0,t.jsx)(s.code,{children:"git reset --hard origin/main"})," instead of just ",(0,t.jsx)(s.code,{children:"git pull"})]}),"\n",(0,t.jsxs)(s.li,{children:["Run ",(0,t.jsx)(s.code,{children:"npm ci"})," (not ",(0,t.jsx)(s.code,{children:"npm install"}),") to match CI's dependency resolution"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"when-local-build-fails-but-ci-passes",children:"When local build fails but CI passes"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["Run ",(0,t.jsx)(s.code,{children:"git status --short"})," \u2014 check for unexpected changes"]}),"\n",(0,t.jsxs)(s.li,{children:["If stale index detected: ",(0,t.jsx)(s.code,{children:"git reset --hard HEAD"})]}),"\n",(0,t.jsxs)(s.li,{children:["Run ",(0,t.jsx)(s.code,{children:"npm ci"})," to ensure clean dependencies"]}),"\n",(0,t.jsx)(s.li,{children:"Rebuild and verify"}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"in-multi-worker-environments",children:"In multi-worker environments"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Avoid ",(0,t.jsx)(s.code,{children:"git stash"})," \u2014 prefer clean clones or ",(0,t.jsx)(s.code,{children:"git reset --hard"})]}),"\n",(0,t.jsx)(s.li,{children:"Treat local checkouts as ephemeral"}),"\n",(0,t.jsx)(s.li,{children:"Always start sessions with a hard reset to the remote branch"}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"related-lessons",children:"Related Lessons"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.em,{children:"(none yet)"})}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://git-scm.com/docs/git-reset",children:"Git documentation: git-reset"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://git-scm.com/docs/git-stash",children:"Git documentation: git-stash"})}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Template version:"})," 1.0\n",(0,t.jsx)(s.strong,{children:"Last updated:"})," 2026-02-10"]})]})}function h(e={}){const{wrapper:s}={...(0,l.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453(e,s,n){n.d(s,{R:()=>r,x:()=>d});var i=n(96540);const t={},l=i.createContext(t);function r(e){const s=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(l.Provider,{value:s},e.children)}}}]);